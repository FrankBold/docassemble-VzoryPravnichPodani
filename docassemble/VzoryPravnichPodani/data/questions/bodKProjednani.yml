metadata:
  title: Bod k projednaní na obci
  short title: bod_k_projednani
  description: Žádost o zařazení bodu na jednání zastupitelstva či rady obce
  authors:
    - name: Michal Kuk
      organization: Frank Bold Society
  revision_date: 2021-08-12
---
features:
  question help button: True
  question back button: True
  navigation back button: False
---
modules:
  - .integrace
  - .overovac
  - .utility
  - .pocetObyvatel
---
objects:
  - Podatel: Person.using(nazev="podatele")
  - Adresat: Organization
  - Podani: Thing
  - userdata: DAStore
---
mandatory: True
code: |
  nabidkaFBA = False
  nazev = "Žádost o zařazení bodu na zasedání"
  if userdata.get("prefs"):
    Podatel.name.text = userdata.get("prefs").name+" "+userdata.get("prefs").surname
    Podatel.address = userdata.get("prefs").address
    Podatel.birthday = userdata.get("prefs").birthday
    email = userdata.get("prefs").email
    Podani.odpoved = userdata.get("prefs").odeslani
    Podatel.idds = userdata.get("prefs").idds
  Adresat.organ
  pocetPodpisu_Info
  final_fr
---
include:
  - t_mail.yml
  - objektPerson.yml
  - final_screen.yml
---
question: |
  Vyberte z jakého okresu je Vámi zadaná obec
fields:
  - Okres: okres
    datatype: radio
    code: |
      moznosti
---
event: nenalezeno
question: |
  Bohužel jsme nic nenašli, zkuste to znovu.
buttons:
  - Zkusit znovu: restart
---
sets: Podani.pocetPodpis
code: |
  vystup = pocetObyvatel(Adresat.obec)
  if len(vystup) == 1:
    pocetPodpisu = round(int(vystup[0][2])*0.005)
    Podani.pocetPodpis = range(1, pocetPodpisu+1)
  elif len(vystup) == 0:
    nenalezeno
  elif len(vystup) > 1:
    moznosti = []
    for item in vystup:
      moznosti.append(item[0])
    for polozka in vystup:
      if polozka[0] == okres:
        pocetPodpisu = round(int(polozka[2])*0.005)
        Podani.pocetPodpis = range(1, pocetPodpisu+1)
---
ga id: adresat
question: |
  Obec, která má věc projednat
subquestion: |
  Žádost adresujete přímo dané obci, která má věc projednat.
fields:
  - Způsob zadání: rucne
    input type: radio
    choices:
        - Vyplním ručně: True
        - Dle ID datové schránky: False
  - ID datové schránky: Adresat.idds
    show if:
      variable: rucne
      is: False
---
ga id: adresatRucne
if: |
  rucne
question: |
  Adresa obecního úřadu
subquestion: |
  % if defined('hlaska'):
  <div class="alert alert-warning">
  Bohužel se nepodařilo údaje doplnit automaticky. Zadejte je prosím ručně.
  </div>
  % endif

  Podle obce dopočítáme potřebný počet podpisů, dle počtu obyvatel. Žádost musí být podpořena pospisy alespoň 0,5 % obyvatel obce.
fields:
  - Ulice a čp: Adresat.ulice
  - Obec: Adresat.obec
  - PSČ: Adresat.psc
---
# Získání údajů o kraji
if: |
  rucne == False
code: |
  vystup_urad = uradDleDatovky(Adresat.idds)
  if vystup_urad == "chyba":
    rucne = True
    hlaska = True
    Adresat.name.text
  else:
    Adresat.name.text = vystup_urad['NazevOsoby']
    if vystup_urad['AdresaSidla']['UliceNazev']:
      if vystup_urad['AdresaSidla']['CisloOrientacni'] and vystup_urad['AdresaSidla']['CisloDomovni']:
        Adresat.ulice = str(vystup_urad['AdresaSidla']['UliceNazev']) +" "+ str(vystup_urad['AdresaSidla']['CisloDomovni']) +"/"+ str(vystup_urad['AdresaSidla']['CisloOrientacni'])
      elif vystup_urad['AdresaSidla']['CisloDomovni']:
        Adresat.ulice = str(vystup_urad['AdresaSidla']['UliceNazev']) +" "+ str(vystup_urad['AdresaSidla']['CisloDomovni'])
      else:
        Adresat.ulice = str(vystup_urad['AdresaSidla']['UliceNazev'])
    else:
      if vystup_urad['AdresaSidla']['CisloDomovni']:
        Adresat.ulice = str(vystup_urad['AdresaSidla']['ObecNazev']) +" "+ str(vystup_urad['AdresaSidla']['CisloDomovni'])
      else:
        Adresat.ulice = str(vystup_urad['AdresaSidla']['ObecNazev'])
    Adresat.psc = vystup_urad['AdresaSidla']['PostaKod']
    Adresat.obec = vystup_urad['AdresaSidla']['ObecNazev']
    Adresat.idds = vystup_urad['ISDS']
---
# Otázky
# Úřad, který příkaz vydal
ga id: Předmět
question: |
  Projednání záležitosti
subquestion: |
  Projednání záležitosti můžete požadovat buď po zastupitelstvu či radě obce. Záleží na tom, pod jaký z orgánů záležitost spadá.
fields:
  - Orgán obce: Adresat.organ
    datatype: radio
    choices:
        - Zastupitelstvo obce: zastupitestvo
        - Rada obce: rada
  - Popis záležitosti kterou chcete projednat: Podani.obsah
    input type: area
---
question: |
  Počet podpisů
subquestion: |
  Vaší žádost musí podle [zákona o obcích](https://www.zakonyprolidi.cz/cs/2000-128#p16-2-f) podpořit alespoň 0,5 % obyvatel obce.

  Podle údajů o počtu obyvatel k 1.1.2021 to pro obec ${ Adresat.obec }, znamená **${ pocetPodpisu } podpisů.**

  Do vzoru jsme vám přidali potřebný počet podpisových řádků. Podpisy musíte získat před odesláním žádosti obci.
continue button field: pocetPodpisu_Info
---
# Odeslání souborů
need: vzor
id: souboryKeStazeni
progress: 100
question: |
  Vaš vzor je připraven
subquestion: |
  Vzor vám zašleme na e-mailovou adresu.

  % if user_has_privilege('admin'):
  [Stáhnout](${ vzor.url_for() })
  % endif
fields:
  - Váš e-mail: email
    datatype: email
  - Přihlásit k odběru novinek: novinky
    datatype: yesno
---
# Odeslání e-mailu se vzorem. Zároveň přidání kontaktu k mailing listu v rámci Ecomailu.
event: odeslatEmail
sets: vseHotovo
code: |
  vzor
  emailOdeslan = send_email(email, template=t_vzor, attachments=[vzor])
  if novinky:
    ecomail = addEcomail(email, "96", "Bod k zasedání")
  if emailOdeslan:
    vseHotovo = True
    webhook_data = requests.post('https://hook.integromat.com/ekpnq1umeahy5pl2baq6czmplr7lfbvt', data=json.dumps(all_variables()),headers={'Content-Type': 'application/json'})
  else:
    neodeslano
---
attachment:
  name: Bod k zasedání
  filename: Žádost
  variable name: vzor
  docx template file: BodKProjednani.docx
  valid formats:
    - docx
